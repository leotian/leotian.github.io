<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">
<link rel="manifest" href="/manifest.json">


  
  
    
      
    
    
      
    
  <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
  <link href="//cdn.bootcss.com/pace/1.0.2/themes/blue/pace-theme-flash.min.css" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
    
  
  <link href="//cdn.jsdelivr.net/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet" type="text/css">







  

<link href="//cdn.bootcss.com/font-awesome/4.6.2/css/font-awesome.min.css" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css">


  <meta name="keywords" content="工具,编译器,babel,7.0版本,">








  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.png?v=5.1.2">






<meta name="description" content="8月底Babel官方宣布正式推出 Babel 7.0。这次 Babel 7 的发布，距离上次 Babel 6 的发布差不多过去了整整 3 年的时间。之前的两篇文章都是基于Babel 6，最近我们升级了Babel 7，总结一下变化。">
<meta name="keywords" content="工具,编译器,babel,7.0版本">
<meta property="og:type" content="article">
<meta property="og:title" content="升级Babel到7版本">
<meta property="og:url" content="https://leotian.cn/posts/a5bd/index.html">
<meta property="og:site_name" content="天生爱走神">
<meta property="og:description" content="8月底Babel官方宣布正式推出 Babel 7.0。这次 Babel 7 的发布，距离上次 Babel 6 的发布差不多过去了整整 3 年的时间。之前的两篇文章都是基于Babel 6，最近我们升级了Babel 7，总结一下变化。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://images.leotian.cn/blog/2019-04-29-101907.jpg">
<meta property="og:image" content="https://images.leotian.cn/blog/2019-04-29-101908.jpg">
<meta property="og:image" content="https://images.leotian.cn/blog/2019-04-29-101909.jpg">
<meta property="og:image" content="https://images.leotian.cn/blog/2019-04-29-101910.jpg">
<meta property="og:image" content="https://images.leotian.cn/blog/2019-04-29-101911.jpg">
<meta property="og:image" content="https://images.leotian.cn/blog/2019-04-29-101912.jpg">
<meta property="og:image" content="https://images.leotian.cn/blog/2019-04-29-101913.jpg">
<meta property="og:image" content="https://images.leotian.cn/blog/2019-04-29-101914.jpg">
<meta property="og:image" content="https://images.leotian.cn/blog/2019-04-29-101915.jpg">
<meta property="og:updated_time" content="2019-04-29T10:21:07.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="升级Babel到7版本">
<meta name="twitter:description" content="8月底Babel官方宣布正式推出 Babel 7.0。这次 Babel 7 的发布，距离上次 Babel 6 的发布差不多过去了整整 3 年的时间。之前的两篇文章都是基于Babel 6，最近我们升级了Babel 7，总结一下变化。">
<meta name="twitter:image" content="https://images.leotian.cn/blog/2019-04-29-101907.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.2',
    sidebar: {"position":"right","display":"always","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: 'MTRGWT9OKH',
      apiKey: '83c0e99cb156fe27d37705002f709791',
      indexName: 'blog',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://leotian.cn/posts/a5bd/">





  <title>升级Babel到7版本 | 天生爱走神</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-right page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">天生爱走神</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">其实，我是一个天真活泼、充满创意的年轻人</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  
  <div class="algolia-popup popup search-popup">
    <div class="algolia-search">
      <div class="algolia-search-input-icon">
        <i class="fa fa-search"></i>
      </div>
      <div class="algolia-search-input" id="algolia-search-input"></div>
    </div>

    <div class="algolia-results">
      <div id="algolia-stats"></div>
      <div id="algolia-hits"></div>
      <div id="algolia-pagination" class="algolia-pagination"></div>
    </div>

    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
  </div>




    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://leotian.cn/posts/a5bd/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Leo.Tian">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天生爱走神">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">升级Babel到7版本</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-14T14:54:29+08:00">
                2018-11-14
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/posts/a5bd/" class="leancloud_visitors" data-flag-title="升级Babel到7版本">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>8月底Babel官方宣布正式推出 Babel 7.0。这次 Babel 7 的发布，距离上次 Babel 6 的发布差不多过去了整整 3 年的时间。之前的两篇文章都是基于Babel 6，最近我们升级了Babel 7，总结一下变化。</p>
<p><img src="https://images.leotian.cn/blog/2019-04-29-101907.jpg" alt="âbabel 7âçå¾çæç´¢ç&quot;æ"><a id="more"></a></p>
<h1 id="主要变化"><a href="#主要变化" class="headerlink" title="主要变化"></a>主要变化</h1><p>这次更新号称断崖式变更，更新内容较多，我会挑选一些我注意到的重要变化，完整的列表可以参考<a href="https://babeljs.io/docs/en/v7-migration" target="_blank" rel="noopener">官网</a>，并且肯定还有很多东西需要动态调整，所以大家有什么觉得不对的地方建议去官网验证并且回来留言告诉我。</p>
<h2 id="Renames（命名变化）"><a href="#Renames（命名变化）" class="headerlink" title="Renames（命名变化）"></a>Renames（命名变化）</h2><h3 id="Scoped-Packages"><a href="#Scoped-Packages" class="headerlink" title="Scoped Packages"></a>Scoped Packages</h3><p>Babel 团队会从7版本开始通过使用 “scoped” packages 的方式，来给自己的 babel package name 加上 @babel 命名空间（<a href="http://babeljs.io/blog/2017/12/27/nearing-the-7.0-release#renames-scoped-packages-babel-x" target="_blank" rel="noopener">详情</a>），这样以便于区分官方 package 以及 非官方 package，所以 babel-core 会变成 @babel/core。至于选择scoped packages更多的好处可以看<a href="https://babeljs.io/blog/2017/12/27/nearing-the-7.0-release#renames-scoped-packages-babel-x" target="_blank" rel="noopener">这里</a>。</p>
<h3 id="plugin统一使用proposal"><a href="#plugin统一使用proposal" class="headerlink" title="plugin统一使用proposal"></a>plugin统一使用proposal</h3><p>放弃 <code>Stage</code> presets（<code>@babel/preset-stage-0</code> 等），选择支持单个 proposal。相似的地方还有，会默认移除 <code>@babel/polyfill</code>对 proposals 支持（<a href="https://github.com/babel/babel/pull/8440" target="_blank" rel="noopener">详情</a>）。想知道更多相关的细节，可以考虑阅读整篇<a href="https://babeljs.io/blog/2018/07/27/removing-babels-stage-presets" target="_blank" rel="noopener">博文</a>。</p>
<p>所有 TC39 proposal plugin 的名字都已经变成以 <code>@babel/plugin-proposal</code> 开头，替换之前的 <code>@babel/plugin-transform</code>（<a href="http://babeljs.io/blog/2017/12/27/nearing-the-7.0-release#renames-proposal" target="_blank" rel="noopener">详情</a>）。有些 package 已经换名字，所以 <code>@babel/plugin-transform-class-properties</code> 变成 <code>@babel/plugin-proposal-class-properties</code>。</p>
<h3 id="Drop-the-year-from-the-plugin-name"><a href="#Drop-the-year-from-the-plugin-name" class="headerlink" title="Drop the year from the plugin name"></a>Drop the year from the plugin name</h3><p>如果插件名称中包含了规范名称 (<code>-es2015-</code>, <code>-es3-</code> 之类的)，一律删除。例如 <code>babel-plugin-transform-es2015-classes</code> 变成了 <code>@babel/plugin-transform-classes</code>。</p>
<h2 id="presets"><a href="#presets" class="headerlink" title="presets"></a>presets</h2><h3 id="弃用年份-presets"><a href="#弃用年份-presets" class="headerlink" title="弃用年份 presets"></a>弃用年份 presets</h3><p>弃用（并且停止发布）所有与 yearly 有关的 presets（<code>preset-es2015</code> 等）（<a href="http://babeljs.io/blog/2017/12/27/nearing-the-7.0-release#deprecated-yearly-presets-eg-babel-preset-es20xx" target="_blank" rel="noopener">详情</a>）。<code>@babel/preset-env</code> 会取代这些 <code>presets</code>，这是因为 <code>@babel/preset-env</code> 囊括了所有 yearly <code>presets</code> 的功能，而且<code>@babel/preset-env</code> 还具备了针对特定浏览器进行“因材施教”的能力，而不需要开发者投入精力。凡是使用 es201x 的开发者，都应当使用 env 进行替换。但这里的弃用（原文 deprecated）并不是删除，只是不推荐使用了（好像马上就准备删了）。</p>
<h3 id="弃用-stage-x"><a href="#弃用-stage-x" class="headerlink" title="弃用 stage-x"></a>弃用 stage-x</h3><p>如上面所说，stage-x 不再维护了。这是因为 babel 团队认为为这些 “不稳定的草案” 花费精力去更新 preset 相当浪费。stage-x 虽然停止维护（同样也是deprecated），但它包含的插件并没有删除（只是被更名了），我们依然可以显式地声明这些插件来获得等价的效果。<a href="https://github.com/babel/babel/tree/master/packages/babel-preset-stage-0#babelpreset-stage-0" target="_blank" rel="noopener">完整列表</a>。</p>
<h2 id="babel-runtime"><a href="#babel-runtime" class="headerlink" title="babel-runtime"></a>babel-runtime</h2><h3 id="拆分-babel-runtime"><a href="#拆分-babel-runtime" class="headerlink" title="拆分 babel-runtime"></a>拆分 <code>babel-runtime</code></h3><p><code>@babel/runtime</code> 是 babel 生态里最让人困惑的一个包，好像到处都有。而在 babel 7 下，我们还多了一个 <code>@babel/runtime-corejs2</code>。之前的 <code>@babel/runtime</code> 已经被分成 <code>@babel/runtime</code> 以及 <code>@babel/runtime-corejs2</code>（<a href="https://github.com/babel/babel/pull/8266" target="_blank" rel="noopener">PR</a>）。前者保留了 regenerator-runtime 函数和 helpers，后者保留了 polyfill 函数（例如，Symbol，Promise，其实就是拆出了core-js，运行时扩展包括的两个内容拆开了）、regenerator-runtime 函数和 helpers（目前看到是这样的）。corejs2的使用方法如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">"plugins": [</span><br><span class="line">    [<span class="string">"@babel/plugin-transform-runtime"</span>,&#123;<span class="attr">"corejs"</span>: <span class="number">2</span>&#125;]</span><br><span class="line">  ]</span><br></pre></td></tr></table></figure>
<p>所以现在使用<code>@babel/plugin-transform-runtime</code>搭配<code>@babel/runtime</code>的话其实只有 regenerator 的转换，填充是没有的，具体配置请看<a href="https://babeljs.io/docs/en/babel-plugin-transform-runtime#corejs" target="_blank" rel="noopener">这里</a>（设为true的话是从core-js作填充，所以必须要装core-js，不过装<code>@babel/register</code>的话会带core-js）。</p>
<h3 id="Remove-proposal-polyfills-in-babel-polyfill"><a href="#Remove-proposal-polyfills-in-babel-polyfill" class="headerlink" title="Remove proposal polyfills in @babel/polyfill"></a><a href="https://babel.docschina.org/docs/en/v7-migration#remove-proposal-polyfills-in-babel-polyfill-https-githubcom-babel-babel-issues-8416" target="_blank" rel="noopener">Remove proposal polyfills in <code>@babel/polyfill</code></a></h3><p>基于和废弃stage相似的思想，<code>@babel/polyfill</code>（ <a href="https://github.com/babel/babel/blob/master/packages/babel-polyfill/src/index.js" target="_blank" rel="noopener">Source</a>）中的 polyfill proposals也被删除。现在<code>@babel/polyfill</code> 几乎就是<code>@babel/runtime-corejs2</code>的一个别名，包含的内容只有<code>core-js</code>和<code>regenerator-runtime</code>（说几乎可能是因为<code>@babel/runtime-corejs2</code>多了helpers）。</p>
<h3 id="自动-polyfill（实验性质）"><a href="#自动-polyfill（实验性质）" class="headerlink" title="自动 polyfill（实验性质）"></a>自动 polyfill（实验性质）</h3><p>在环境不支持一些新特性如 Promise，Symbol，而你需要开启的情况下，就需要 Polyfills。能够区分得出 Babel 在作为编译器（转换语法）以及 作为 polyfill（实现内置的方法/对象）都做了哪些事情，这很重要。</p>
<p>之前我们只需要简单的引入一套完整的解决方案，比如 <code>@babel/polyfill</code>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">"@babel/polyfill"</span>;</span><br></pre></td></tr></table></figure>
<p>但是 <code>@babel/polyfill</code> 会把整个 polyfill 都 import 进来（something that covers everything），而且如果浏览器已经支持一些特性，那么就没有必要把整个 polyfill 给 import 进来。<code>@babel/preset-env</code> 所解决的语法问题和 polyfill 所解决的问题，其实是同一个问题——兼容性，所以在这里会把 <code>@babel/preset-env</code> 应用在解决 polyfill 问题上。设置 useBuiltins: “entry” 可以解决整个 polyfill 被 import 的问题（根据<code>target</code>中浏览器版本的支持，将<code>polyfills</code>拆分引入，仅引入不支持的<code>polyfill</code>）。</p>
<p>但其实我们能做的更好，我们可以只 import 代码中用到的 polyfill，最好可以检测代码中<code>ES6/7/8</code>等的使用情况，仅仅加载代码中用到的<code>polyfills</code>。设置 useBuiltIns: “usage” 就可以开启类似的功能（<a href="https://babeljs.io/docs/en/babel-preset-env#usebuiltins" target="_blank" rel="noopener">文档</a>）。</p>
<p>tip：这到底是如何做到的呢？对于JS这种动态语言来说，只静态分析应该无法做到这一步，必须要加载执行后才可以，还需要经过大量测试，解析AST甚至是模拟引擎执行？</p>
<h2 id="JavaScript-配置文件"><a href="#JavaScript-配置文件" class="headerlink" title="JavaScript 配置文件"></a>JavaScript 配置文件</h2><h3 id="babel-config-js"><a href="#babel-config-js" class="headerlink" title="babel.config.js"></a>babel.config.js</h3><p>Babel 7 正在引入<a href="https://babeljs.io/docs/en/next/config-files#project-wide-configuration" target="_blank" rel="noopener"><code>babel.config.js</code></a>。注意：使用 <code>babel.config.js</code> 并不是一个必要条件；或者也可以这样说，<code>babel.config.js</code>甚至不是 <code>.babelrc</code> 的替代品，不过在一些特定的场景下，使用 <code>babel.config.js</code> 还是有帮助的。</p>
<p>用 <code>*.js</code> 来做配置文件的做法，在 JavaScript 的生态里面已经相当常见。ESlint 和 Webpack 都已经考虑到用 <code>.eslintrc.js</code> 以及 <code>webpack.config.js</code> 来做配置文件。</p>
<p>下面说的就是这个例子 —— 只会在“生产”环境中使用 <code>babel-plugin-that-is-cool</code> 插件来编译（当然，你也可以在 <code>.babelrc</code> 配置文件，通过配置 <code>env</code> 配置项的方式来做这件事）：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> env = process.env.NODE_ENV;</span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  plugins: [</span><br><span class="line">    env === <span class="string">"production"</span> &amp;&amp; <span class="string">"babel-plugin-that-is-cool"</span></span><br><span class="line">  ].filter(<span class="built_in">Boolean</span>)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="babelrc的查找行为"><a href="#babelrc的查找行为" class="headerlink" title=".babelrc的查找行为"></a>.babelrc的<a href="https://www.babeljs.cn/docs/usage/babelrc/#%E6%9F%A5%E6%89%BE%E8%A1%8C%E4%B8%BA" target="_blank" rel="noopener">查找行为</a></h3><p>Babel6会在正在被转录的文件的当前目录中查找一个 <code>.babelrc</code> 文件。 如果不存在，它会遍历目录树，直到找到一个 <code>.babelrc</code> 文件，或一个 <code>package.json</code> 文件中有 <code>&quot;babel&quot;: {}</code> 。比如使用babel-register，你可以使用<a href="https://babel.bootcss.com/docs/usage/babel-register/#%E6%8C%87%E5%AE%9A%E9%80%89%E9%A1%B9" target="_blank" rel="noopener">选项</a>，包括 <code>plugins</code> 和 <code>presets</code>等等，但是每个文件最接近的 <a href="https://babeljs.io/docs/usage/babelrc/" target="_blank" rel="noopener"><code>.babelrc</code></a> 仍然适用，并且优先于你在此处传入的任何选项，如果不想查找只能在选项中使用 “babelrc”: false 来停止查找行为，或者提供–no-babelrc CLI 标志。</p>
<p>与 <code>.babelrc</code> 相比，针对查找配置文件的这件事，Babel 对 <code>babel.config.js</code> 有着不同的解决方案。Babel 总是会先从 <code>babel.config.js</code> 来获取配置内容。和 <code>.babelrc</code> 或 <code>package.json</code>中的 <code>babel</code> 字段不同，这个配置文件不会使用基于文件位置的方案，而是会一致地运用到项目根目录以下的所有文件，包括 <code>node_modules</code> 内部的依赖。</p>
<p>这样就可以利用发布的下一个功能，<code>overrides</code>。</p>
<h3 id="使用-overrides，实现配置有选择性的“表达”"><a href="#使用-overrides，实现配置有选择性的“表达”" class="headerlink" title="使用 overrides，实现配置有选择性的“表达”"></a>使用 <code>overrides</code>，实现配置有选择性的“表达”</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  presets: [</span><br><span class="line">    <span class="comment">// defeault config...</span></span><br><span class="line">  ],</span><br><span class="line">  overrides: [&#123;</span><br><span class="line">    test: [<span class="string">"./node_modules"</span>],</span><br><span class="line">    presets: [</span><br><span class="line">      <span class="comment">// config for node_modules</span></span><br><span class="line">    ],</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    test: [<span class="string">"./tests"</span>],</span><br><span class="line">    presets: [</span><br><span class="line">      <span class="comment">// config for tests</span></span><br><span class="line">    ],</span><br><span class="line">  &#125;]</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这样就实现在一个项目当中，可以针对测试代码、客户端代码以及服务端代码使用不同的编译配置（compilation configs），就很好的避免了需要你为每个文件夹都创建一个新的 .babelrc 配置文件的情况。</p>
<h2 id="更多"><a href="#更多" class="headerlink" title="更多"></a>更多</h2><h3 id="Peer-dependencies"><a href="#Peer-dependencies" class="headerlink" title="Peer dependencies"></a>Peer dependencies</h3><p>为所有的 plugins（例如<code>@babel/plugin-class-properties</code>），presets（<code>@babel/preset-env</code>），and 顶级包（<code>@babel/cli</code>、 <code>babel-loader</code>），都加上了 <code>@babel/core</code> 作为 <code>peerDependency</code>（<a href="http://babeljs.io/blog/2017/12/27/nearing-the-7.0-release#peer-dependencies-integrations" target="_blank" rel="noopener">详情</a>）。</p>
<blockquote>
<p>peerDependencies are dependencies expected to be used by your code, as opposed to dependencies only used as an implementation detail — <a href="https://stackoverflow.com/a/34645112" target="_blank" rel="noopener">Stijn de Witt via StackOverflow</a></p>
</blockquote>
<p><code>babel-loader</code> 已经把  <code>babel-core</code>作为<code>peerDependency</code>，所以只是改成了<code>@babel/core</code>。</p>
<h3 id="支持-“Pure”-注释"><a href="#支持-“Pure”-注释" class="headerlink" title="支持 “Pure” 注释"></a>支持 “Pure” 注释</h3><p>在 <a href="https://github.com/babel/babel/pull/6209" target="_blank" rel="noopener">#6209</a> 之后，Babel 编译 ES6 class 之后的代码，会带有 <code>/*#__PURE__*/</code> 注释，至于为啥要这样做呢？是因为 Babel 要给压缩工具留一些线索，以便于压缩工具，比如 <a href="https://github.com/mishoo/UglifyJS2" target="_blank" rel="noopener">Uglify</a>、<a href="https://github.com/babel/minify" target="_blank" rel="noopener">babel-minify</a> 去掉 dead code。这些注释也会用于其它的 helper 函数。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> </span>&#123;</span><br><span class="line">  m() &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> C =</span><br><span class="line"><span class="comment">/*#__PURE__*/</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;();</span><br></pre></td></tr></table></figure>
<h3 id="babel-node-从-babel-cli-中独立"><a href="#babel-node-从-babel-cli-中独立" class="headerlink" title="@babel/node 从 @babel/cli 中独立"></a>@babel/node 从 @babel/cli 中独立</h3><p>和 babel 6 不同，如果要使用 <code>@babel/node</code>，就必须单独安装，并添加到依赖中。</p>
<h3 id="不再支持低版本-node"><a href="#不再支持低版本-node" class="headerlink" title="不再支持低版本 node"></a>不再支持低版本 node</h3><p>对那些已经不维护的 node 版本不予支持，包括 0.10、0.12、4、5（<a href="http://babeljs.io/blog/2017/09/12/planning-for-7.0#drop-support-for-unmaintained-node-versions-010-012-5-4315-https-githubcom-babel-babel-issues-4315" target="_blank" rel="noopener">详情</a>），相当于要求 nodejs &gt;= 6。</p>
<p>这里的不再支持，指的是在这些低版本 node 环境中不能使用 babel 转译代码，但 babel 转译后的代码依然能在这些环境上运行，这点不要混淆。</p>
<h2 id="babel-upgrade"><a href="#babel-upgrade" class="headerlink" title="babel-upgrade"></a>babel-upgrade</h2><p><a href="https://github.com/babel/babel-upgrade" target="_blank" rel="noopener"><code>babel-upgrade</code></a>，Babel 团队开发的新工具，旨在用来处理升级过程中的琐事（changes）：目前只是针对 <code>package.json</code> 的 <code>dependencies</code> 以及 <code>.babelrc</code>配置，它会检测 babel 配置中的 stage-x 并且替换成对应的 plugins。除此之外它还有其他功能，但大目标就是让你更加平滑地迁移到 babel 7。</p>
<p>Babel 团队推荐在项目里面直接运行 <code>npx babel-upgrade</code>，或者你可以通过 <code>npm install -g babel-upgrade</code> 的方式，在全局安装 <code>babel-upgrade</code>。</p>
<p>如果你想修改文件，你可以传 <code>--write</code> 以及 <code>--install</code>。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx babel-upgrade --write --install</span><br></pre></td></tr></table></figure>
<p>这款升级工具的功能包括：（这里并不列出完整列表，只列出比较重要和常用的内容）</p>
<ul>
<li>package.json</li>
</ul>
<ol>
<li>把依赖（和开发依赖）中所有的 <code>babel-*</code> 替换为 <code>@babel/*</code></li>
<li>并把这些 <code>@babel/*</code> 依赖的版本更新为最新版 (例如 <code>^7.0.0</code>)，如果 <code>scripts</code> 中有使用 <code>babel-node</code>，自动添加 <code>@babel/node</code> 为开发依赖</li>
<li>如果有 <code>babel</code> 配置项，检查其中的 <code>plugins</code> 和 <code>presets</code>，把短名（<code>env</code>） 替换为完整的名字 （<code>@babel/preset-env</code>）</li>
</ol>
<ul>
<li>.babelrc</li>
</ul>
<ol>
<li>检查其中的 <code>plugins</code> 和 <code>presets</code>，把短名（<code>env</code>）替换为完整的名字（<code>@babel/preset-env</code>）</li>
<li>检查是否包含 <code>preset-stage-x</code>，如有替换为对应的插件并添加到 <code>plugins</code></li>
</ol>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><table>
<thead>
<tr>
<th style="text-align:center">v7包名（v6包名）</th>
<th style="text-align:center">作用</th>
<th style="text-align:center">备注</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">@babel/cli（babel-cli）</td>
<td style="text-align:center">命令行使用bable命令</td>
<td style="text-align:center">少了一些包，并把@babel/core作为peerDependencies</td>
</tr>
<tr>
<td style="text-align:center">@babel/node（babel-node）</td>
<td style="text-align:center">命令行直接转译 + 执行node文件</td>
<td style="text-align:center"><img src="https://images.leotian.cn/blog/2019-04-29-101908.jpg" alt="image-20181116171602076"><br>依然是babel-polyfill<code>+</code>babel-register，同样把@babel/core作为了peerDependencies</td>
</tr>
<tr>
<td style="text-align:center">@babel/register（babel-register）</td>
<td style="text-align:center">改写require命令，为其加载的文件进行转码，但是不会对当前文件转码，包含了corejs</td>
<td style="text-align:center"><img src="https://images.leotian.cn/blog/2019-04-29-101909.jpg" alt="image-20181116173312093"><br>同样把@babel/core作为了peerDependencies</td>
</tr>
<tr>
<td style="text-align:center">@babel/polyfill（babel-polyfill）</td>
<td style="text-align:center">现在包括corejs和regenerator</td>
<td style="text-align:center"><img src="https://images.leotian.cn/blog/2019-04-29-101910.jpg" alt="image-20181116171914153"></td>
</tr>
<tr>
<td style="text-align:center">@babel/runtime（babel-runtime）</td>
<td style="text-align:center">现在包括regenerator和helpers</td>
<td style="text-align:center"><img src="https://images.leotian.cn/blog/2019-04-29-101911.jpg" alt="image-20181116214155724"></td>
</tr>
<tr>
<td style="text-align:center">@babel/runtime-corejs2</td>
<td style="text-align:center">现在包括corejs、regenerator和helpers</td>
<td style="text-align:center"><img src="https://images.leotian.cn/blog/2019-04-29-101912.jpg" alt="image-20181116171806763"></td>
</tr>
<tr>
<td style="text-align:center">@babel/plugin-transform-runtime（babel-plugin-transform-runtime）</td>
<td style="text-align:center">让 babel 自动且按需的进行 polyfill（不污染全局变量和prototype）</td>
<td style="text-align:center">同样把@babel/core作为了peerDependencies<br><img src="https://images.leotian.cn/blog/2019-04-29-101913.jpg" alt="image-20181116171624202"></td>
</tr>
<tr>
<td style="text-align:center">@babel/core（babel-core）</td>
<td style="text-align:center">原来只是在代码里使用 babel，现在目前来看基本是最重要的一个包了，不管装什么都对把其作为peerDependencies</td>
<td style="text-align:center"><img src="https://images.leotian.cn/blog/2019-04-29-101914.jpg" alt="image-20181116171551115"></td>
</tr>
<tr>
<td style="text-align:center">@babel/preset-env</td>
<td style="text-align:center">整合了 es201x，并自动根据目标平台分析需要用哪些插件</td>
<td style="text-align:center">plugin太多，不截图了，把除了babel开头的截一下，同样把@babel/core作为了peerDependencies<br><img src="https://images.leotian.cn/blog/2019-04-29-101915.jpg" alt="image-20181120222334071"></td>
</tr>
<tr>
<td style="text-align:center">babel-loader（babel-loader）</td>
<td style="text-align:center">使用webpack时作为一个loader，在代码混淆前进行转码</td>
<td style="text-align:center">新版把@babel/core作为peerDependencies</td>
</tr>
<tr>
<td style="text-align:center">babel-eslint（babel-eslint）</td>
<td style="text-align:center">使用eslint时，进行前置转码</td>
<td style="text-align:center">依然把eslint作为<a href="https://nodejs.org/zh-cn/blog/npm/peer-dependencies/" target="_blank" rel="noopener"><code>Peer Dependencies</code></a></td>
</tr>
</tbody>
</table>
<p>暂时先写到这里，其实核心机制方面没有变化，插件，preset，解析转译生成这些都没有变化，但是断舍离方面改动很大。重点看应用吧，下一篇讲应用。</p>
<h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><p><a href="https://www.w3ctech.com/topic/2150" target="_blank" rel="noopener">Babel 7 于今天发布</a></p>
<p><a href="https://babeljs.io/blog/2017/12/27/nearing-the-7.0-release#renames-proposal" target="_blank" rel="noopener">Nearing the 7.0 Release</a>/<a href="https://babel.docschina.org/blog/2018/08/27/7.0.0" target="_blank" rel="noopener">Babel 7 发布</a></p>

      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div></div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>赞赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechatpay.png" alt="Leo.Tian 微信">
        <p>微信</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alipay.png" alt="Leo.Tian 支付宝">
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    Leo.Tian
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://leotian.cn/posts/a5bd/" title="升级Babel到7版本">https://leotian.cn/posts/a5bd/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/工具/" rel="tag"><i class="fa fa-tag"></i> 工具</a>
          
            <a href="/tags/编译器/" rel="tag"><i class="fa fa-tag"></i> 编译器</a>
          
            <a href="/tags/babel/" rel="tag"><i class="fa fa-tag"></i> babel</a>
          
            <a href="/tags/7-0版本/" rel="tag"><i class="fa fa-tag"></i> 7.0版本</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/posts/d0c9/" rel="next" title="再谈Babel-polyfill">
                <i class="fa fa-chevron-left"></i> 再谈Babel-polyfill
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/posts/3b3f/" rel="prev" title="正确使用Babel（1）后端">
                正确使用Babel（1）后端 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="vcomments"></div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          
            <img class="site-author-image" itemprop="image" src="/images/avatar.png" alt="Leo.Tian">
          
            <p class="site-author-name" itemprop="name">Leo.Tian</p>
            <p class="site-description motion-element" itemprop="description">程序员、电影爱好者</p>
        </div>

        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
            
              <a href="/archives/">
            
                <span class="site-state-item-count">48</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">4</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">75</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/leotian" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>GitHub</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.zhihu.com/people/leo.tian" target="_blank" title="知乎">
                  
                    <i class="fa fa-fw fa-globe"></i>知乎</a>
              </span>
            
          
        </div>

        
        
          <div class="cc-license motion-element" itemprop="license">
            <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" target="_blank">
              <img src="/images/cc-by-nc-sa.svg" alt="Creative Commons">
            </a>
          </div>
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#主要变化"><span class="nav-number">1.</span> <span class="nav-text">主要变化</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Renames（命名变化）"><span class="nav-number">1.1.</span> <span class="nav-text">Renames（命名变化）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Scoped-Packages"><span class="nav-number">1.1.1.</span> <span class="nav-text">Scoped Packages</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#plugin统一使用proposal"><span class="nav-number">1.1.2.</span> <span class="nav-text">plugin统一使用proposal</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Drop-the-year-from-the-plugin-name"><span class="nav-number">1.1.3.</span> <span class="nav-text">Drop the year from the plugin name</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#presets"><span class="nav-number">1.2.</span> <span class="nav-text">presets</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#弃用年份-presets"><span class="nav-number">1.2.1.</span> <span class="nav-text">弃用年份 presets</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#弃用-stage-x"><span class="nav-number">1.2.2.</span> <span class="nav-text">弃用 stage-x</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#babel-runtime"><span class="nav-number">1.3.</span> <span class="nav-text">babel-runtime</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#拆分-babel-runtime"><span class="nav-number">1.3.1.</span> <span class="nav-text">拆分 babel-runtime</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Remove-proposal-polyfills-in-babel-polyfill"><span class="nav-number">1.3.2.</span> <span class="nav-text">Remove proposal polyfills in @babel/polyfill</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#自动-polyfill（实验性质）"><span class="nav-number">1.3.3.</span> <span class="nav-text">自动 polyfill（实验性质）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JavaScript-配置文件"><span class="nav-number">1.4.</span> <span class="nav-text">JavaScript 配置文件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#babel-config-js"><span class="nav-number">1.4.1.</span> <span class="nav-text">babel.config.js</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#babelrc的查找行为"><span class="nav-number">1.4.2.</span> <span class="nav-text">.babelrc的查找行为</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用-overrides，实现配置有选择性的“表达”"><span class="nav-number">1.4.3.</span> <span class="nav-text">使用 overrides，实现配置有选择性的“表达”</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#更多"><span class="nav-number">1.5.</span> <span class="nav-text">更多</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Peer-dependencies"><span class="nav-number">1.5.1.</span> <span class="nav-text">Peer dependencies</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#支持-“Pure”-注释"><span class="nav-number">1.5.2.</span> <span class="nav-text">支持 “Pure” 注释</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#babel-node-从-babel-cli-中独立"><span class="nav-number">1.5.3.</span> <span class="nav-text">@babel/node 从 @babel/cli 中独立</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#不再支持低版本-node"><span class="nav-number">1.5.4.</span> <span class="nav-text">不再支持低版本 node</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#babel-upgrade"><span class="nav-number">1.6.</span> <span class="nav-text">babel-upgrade</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#总结"><span class="nav-number">2.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#参考链接"><span class="nav-number">3.</span> <span class="nav-text">参考链接</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy;  2016 &mdash; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-coffee"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Leo.Tian</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动</div>

  <span class="post-meta-divider">|</span>

  <div class="theme-info">主题 &mdash; <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a></div>


<p>Hosted by
  <a href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral" style="border:0">
    <img src="/images/upyun_logo.min.svg" style="width: 60px; display: inline; vertical-align: middle;">
  </a>
  <a href="http://www.miitbeian.gov.cn/">京ICP备17008411号-1</a>
</p>

        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="//cdn.jsdelivr.net/jquery/2.1.3/jquery.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/fastclick/1.0.6/fastclick.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/jquery.lazyload/1.9.3/jquery.lazyload.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/velocity/1.2.3/velocity.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/velocity/1.2.3/velocity.ui.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/fancybox/2.1.5/jquery.fancybox.pack.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>


  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  







  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  <script type="text/javascript">
    new Valine({
        av: AV,
        el: '#vcomments',
        verify: false,
        notify: false,
        app_id: 'GxfYzf5roQxLdedcwOheEnWE-gzGzoHsz',
        app_key: 'MomkTz6Tq1aBGWvzNDSv8o31',
        placeholder: '写下你的想法...',
        avatar: 'retro',
    });
  </script>



  




  
  
  
  <link rel="stylesheet" href="/lib/algolia-instant-search/instantsearch.min.css">

  
  
  <script src="/lib/algolia-instant-search/instantsearch.min.js"></script>
  

  <script src="/js/src/algolia-search.js?v=5.1.2"></script>



  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("GxfYzf5roQxLdedcwOheEnWE-gzGzoHsz", "MomkTz6Tq1aBGWvzNDSv8o31");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

  

  

</body>
</html>
